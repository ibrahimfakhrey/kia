{% extends "admin/base.html" %}

{% block title %}إعادة تعيين كلمات المرور - لوحة التحكم{% endblock %}
{% block page_title %}إعادة تعيين كلمات المرور{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">إعادة تعيين كلمة المرور</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>تحذير:</strong> سيتم تغيير كلمة المرور للمستخدم المحدد أو جميع أولياء الأمور فوراً.
                </div>

                <form method="POST" action="{{ url_for('admin.password_reset') }}">
                    {{ form.hidden_tag() }}

                    <!-- User Selection -->
                    <div class="mb-3">
                        {{ form.user_id.label(class="form-label") }}
                        {{ form.user_id(class="form-select form-select-lg") }}
                        {% if form.user_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.user_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>
                            اختر "All Users" لإعادة تعيين كلمة المرور لجميع أولياء الأمور، أو اختر مستخدم محدد
                        </div>
                    </div>

                    <!-- New Password -->
                    <div class="mb-3">
                        {{ form.new_password.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.new_password(class="form-control form-control-lg", id="newPassword", placeholder="أدخل كلمة المرور الجديدة") }}
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye" id="toggleIcon"></i>
                            </button>
                        </div>
                        {% if form.new_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.new_password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-shield-check me-1"></i>
                            يجب أن تكون كلمة المرور 6 أحرف على الأقل
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-4">
                        {{ form.confirm_password.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.confirm_password(class="form-control form-control-lg", id="confirmPassword", placeholder="أعد إدخال كلمة المرور") }}
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                <i class="bi bi-eye" id="toggleConfirmIcon"></i>
                            </button>
                        </div>
                        {% if form.confirm_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.confirm_password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-danger btn-lg" onclick="return confirm('هل أنت متأكد من إعادة تعيين كلمة المرور؟');">
                            <i class="bi bi-key-fill me-2"></i>
                            إعادة تعيين كلمة المرور
                        </button>
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-arrow-right me-2"></i>
                            إلغاء
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Instructions Card -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    كيفية الاستخدام
                </h6>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">
                        <strong>لإعادة تعيين كلمة المرور لجميع المستخدمين:</strong>
                        <ul>
                            <li>اختر "All Users (All Parents)" من القائمة</li>
                            <li>أدخل كلمة المرور الجديدة</li>
                            <li>أكد كلمة المرور</li>
                            <li>اضغط على "إعادة تعيين كلمة المرور"</li>
                        </ul>
                    </li>
                    <li class="mb-2">
                        <strong>لإعادة تعيين كلمة المرور لمستخدم واحد:</strong>
                        <ul>
                            <li>اختر اسم المستخدم من القائمة</li>
                            <li>أدخل كلمة المرور الجديدة</li>
                            <li>أكد كلمة المرور</li>
                            <li>اضغط على "إعادة تعيين كلمة المرور"</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Statistics Card -->
    <div class="col-lg-4 col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>
                    إحصائيات المستخدمين
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-primary bg-opacity-10 rounded">
                    <div>
                        <h6 class="mb-0 text-muted">إجمالي أولياء الأمور</h6>
                        <h2 class="mb-0 mt-2">{{ users|length }}</h2>
                    </div>
                    <i class="bi bi-people fs-1 text-primary"></i>
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>نصيحة:</strong> يمكنك استخدام هذه الميزة لإعادة تعيين كلمات المرور بشكل جماعي عند بداية العام الدراسي أو في حالة الطوارئ.
                </div>
            </div>
        </div>

        <!-- Recent Users -->
        {% if users %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    أحدث المستخدمين
                </h6>
            </div>
            <div class="list-group list-group-flush">
                {% for user in users[:5] %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ user.full_name }}</h6>
                            <small class="text-muted">{{ user.email }}</small>
                        </div>
                        <span class="badge bg-{{ 'success' if user.is_active else 'secondary' }}">
                            {{ 'نشط' if user.is_active else 'غير نشط' }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('newPassword');
        const icon = document.getElementById('toggleIcon');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    });

    document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('confirmPassword');
        const icon = document.getElementById('toggleConfirmIcon');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    });

    // Password strength indicator
    document.getElementById('newPassword').addEventListener('input', function() {
        const password = this.value;
        const length = password.length;

        // Simple password strength feedback
        if (length < 6) {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });

    // Match password validation
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('newPassword').value;
        const confirmPassword = this.value;

        if (password === confirmPassword && confirmPassword.length >= 6) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    });
</script>
{% endblock %}
